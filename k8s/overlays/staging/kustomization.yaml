apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- ../../base

# Image tags - same as production, updated by CI pipeline
images:
- name: registry.localhost:5000/worker
  newName: ghcr.io/ejkkan/offsenda-worker
  newTag: main-34dde73
- name: registry.localhost:5000/web
  newName: ghcr.io/ejkkan/offsenda-web
  newTag: main-e2426ec
- name: registry.localhost:5000/migration
  newName: ghcr.io/ejkkan/offsenda-migration
  newTag: main-34dde73

patches:
# Exclude in-cluster PostgreSQL - using external database via DATABASE_URL
- patch: |-
    $patch: delete
    apiVersion: apps/v1
    kind: StatefulSet
    metadata:
      name: postgres
      namespace: batchsender
  target:
    kind: StatefulSet
    name: postgres
- patch: |-
    $patch: delete
    apiVersion: v1
    kind: Service
    metadata:
      name: postgres
      namespace: batchsender
  target:
    kind: Service
    name: postgres
- patch: |-
    $patch: delete
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: postgres-init
      namespace: batchsender
  target:
    kind: ConfigMap
    name: postgres-init

# Worker config for staging
- patch: |-
    - op: replace
      path: /data/EMAIL_PROVIDER
      value: resend
    - op: replace
      path: /data/NODE_ENV
      value: staging
    - op: replace
      path: /data/NATS_TLS_ENABLED
      value: "true"
    - op: replace
      path: /data/NATS_CLUSTER
      value: "tls://nats.batchsender.svc:4222"
  target:
    kind: ConfigMap
    name: worker-config

# Worker - reduced resources for staging
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 100m
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 256Mi
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 500m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 512Mi
  target:
    kind: Deployment
    name: worker

# KEDA - lower thresholds for staging (scale up faster with less load)
- patch: |-
    - op: replace
      path: /spec/maxReplicaCount
      value: 10
    - op: replace
      path: /spec/minReplicaCount
      value: 1
  target:
    kind: ScaledObject
    name: worker-scaler

# NATS - single replica for staging (no HA, cost savings)
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 1
  target:
    kind: StatefulSet
    name: nats

# NATS HPA - reduced for staging
- patch: |-
    - op: replace
      path: /spec/minReplicas
      value: 1
    - op: replace
      path: /spec/maxReplicas
      value: 3
  target:
    kind: HorizontalPodAutoscaler
    name: nats-hpa

# NATS PDB - allow all pods to be evicted in staging
- patch: |-
    - op: replace
      path: /spec/minAvailable
      value: 0
  target:
    kind: PodDisruptionBudget
    name: nats-pdb

# Web - single replica for staging
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 1
  target:
    kind: Deployment
    name: web

# ClickHouse - reduced resources for staging
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 200m
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 512Mi
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 1000m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 2Gi
  target:
    kind: StatefulSet
    name: clickhouse

# Staging labels
labels:
- pairs:
    environment: staging

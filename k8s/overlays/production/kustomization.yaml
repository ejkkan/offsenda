apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- ../../base

# Image tags - updated by CI pipeline
images:
- name: ghcr.io/ejkkan/offsenda-worker
  newTag: main-288d930
- name: ghcr.io/ejkkan/offsenda-web
  newTag: main-3fd39b8
- name: ghcr.io/ejkkan/offsenda-migration
  newTag: main-288d930

# Production patches
  # Use production image from container registry

  # Use real email provider

  # Higher resource limits for production

  # KEDA autoscaling for production (instant scaling based on queue depth)

  # For testing with limited resources, scale down NATS to 1 replica

  # Configure NATS for single-node mode
patches:
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/image
      value: ghcr.io/ejkkan/offsenda-worker:latest
  target:
    kind: Deployment
    name: worker
- patch: |-
    - op: replace
      path: /data/EMAIL_PROVIDER
      value: resend
    - op: replace
      path: /data/NODE_ENV
      value: production
    - op: replace
      path: /data/NATS_TLS_ENABLED
      value: "true"
    - op: replace
      path: /data/NATS_CLUSTER
      value: "tls://nats.batchsender.svc:4222"
    - op: add
      path: /data/ENABLE_TEST_SETUP_API
      value: "true"
  target:
    kind: ConfigMap
    name: worker-config
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 200m
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 512Mi
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 1000m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 1Gi
  target:
    kind: Deployment
    name: worker
- patch: |-
    - op: replace
      path: /spec/maxReplicaCount
      value: 50
    - op: replace
      path: /spec/minReplicaCount
      value: 2
  target:
    kind: ScaledObject
    name: worker-scaler
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 1
  target:
    kind: StatefulSet
    name: nats

# Override NATS config for production single-node TLS
- path: nats-configmap.yaml
  target:
    kind: ConfigMap
    name: nats-config

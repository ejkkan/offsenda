apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- ../../base

# Image tags - updated by CI pipeline
images:
- name: registry.localhost:5000/worker
  newName: ghcr.io/ejkkan/offsenda-worker
  newTag: main-c4e56b0
- name: registry.localhost:5000/web
  newName: ghcr.io/ejkkan/offsenda-web
  newTag: main-6437ed5
- name: registry.localhost:5000/migration
  newName: ghcr.io/ejkkan/offsenda-migration
  newTag: main-c4e56b0

patches:
# Exclude in-cluster PostgreSQL - using external database via DATABASE_URL
- patch: |-
    $patch: delete
    apiVersion: apps/v1
    kind: StatefulSet
    metadata:
      name: postgres
      namespace: batchsender
  target:
    kind: StatefulSet
    name: postgres
- patch: |-
    $patch: delete
    apiVersion: v1
    kind: Service
    metadata:
      name: postgres
      namespace: batchsender
  target:
    kind: Service
    name: postgres
- patch: |-
    $patch: delete
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: postgres-init
      namespace: batchsender
  target:
    kind: ConfigMap
    name: postgres-init
# Worker config for production
- patch: |-
    - op: replace
      path: /data/EMAIL_PROVIDER
      value: resend
    - op: replace
      path: /data/NODE_ENV
      value: production
    - op: replace
      path: /data/NATS_TLS_ENABLED
      value: "true"
    - op: replace
      path: /data/NATS_CLUSTER
      value: "tls://nats.batchsender.svc:4222"
    - op: add
      path: /data/ENABLE_TEST_SETUP_API
      value: "true"
  target:
    kind: ConfigMap
    name: worker-config
# Worker resources for production
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 200m
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 512Mi
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 1000m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 1Gi
  target:
    kind: Deployment
    name: worker
# KEDA autoscaling for production
- patch: |-
    - op: replace
      path: /spec/maxReplicaCount
      value: 50
    - op: replace
      path: /spec/minReplicaCount
      value: 2
  target:
    kind: ScaledObject
    name: worker-scaler
# Override NATS config for production TLS cluster
- path: nats-configmap.yaml
  target:
    kind: ConfigMap
    name: nats-config

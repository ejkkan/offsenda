apiVersion: v1
kind: ConfigMap
metadata:
  name: worker-config
  namespace: batchsender
data:
  # Email provider (mock, resend, ses)
  EMAIL_PROVIDER: "mock"

  # Node environment
  NODE_ENV: "development"

  # Service URLs (use kubernetes service DNS)
  # Split Dragonfly for isolation: critical (fail-closed) vs auxiliary (fail-open)
  DRAGONFLY_URL: "dragonfly.batchsender.svc:6379"
  DRAGONFLY_CRITICAL_URL: "dragonfly-critical.batchsender.svc:6379"
  DRAGONFLY_AUXILIARY_URL: "dragonfly-auxiliary.batchsender.svc:6379"
  NATS_CLUSTER: "nats://nats.batchsender.svc:4222"
  CLICKHOUSE_URL: "http://clickhouse.batchsender.svc:8123"

  # NATS TLS (enabled in production overlay)
  NATS_TLS_ENABLED: "false"
  NATS_TLS_CA_FILE: "/etc/nats-certs/ca.crt"
  CLICKHOUSE_DATABASE: "batchsender"
  CLICKHOUSE_USER: "default"

  # Worker settings
  WORKER_CONCURRENCY: "10"
  LOG_LEVEL: "info"

  # Batch Recovery (auto-fix stuck batches)
  BATCH_RECOVERY_ENABLED: "true"
  BATCH_RECOVERY_INTERVAL_MS: "300000"
  BATCH_RECOVERY_THRESHOLD_MS: "900000"

  # Webhook Resilience (retry + circuit breaker)
  WEBHOOK_TIMEOUT_MS: "30000"
  WEBHOOK_MAX_RETRIES: "3"
  WEBHOOK_CIRCUIT_BREAKER_ENABLED: "true"

  # Audit Logging
  AUDIT_ENABLED: "true"
  AUDIT_LOG_TO_CONSOLE: "false"

  # Test Setup API (for load testing)
  ENABLE_TEST_SETUP_API: "true"

  # Dry run latency simulation (realistic provider behavior)
  DRY_RUN_LATENCY_MIN_MS: "50"
  DRY_RUN_LATENCY_MAX_MS: "500"
# Updated Wed Jan 22 2026

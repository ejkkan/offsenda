apiVersion: batch/v1
kind: Job
metadata:
  name: db-migration
  namespace: batchsender
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
  labels:
    app: db-migration
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 86400  # Cleanup after 24 hours
  template:
    metadata:
      labels:
        app: db-migration
    spec:
      serviceAccountName: worker
      restartPolicy: OnFailure

      containers:
      - name: migrate
        image: ghcr.io/ejkkan/offsenda-migration:latest
        imagePullPolicy: Always
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: worker-secrets
              key: DATABASE_URL

        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi

      imagePullSecrets:
      - name: ghcr-credentials

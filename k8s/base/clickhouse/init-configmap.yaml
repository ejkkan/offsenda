apiVersion: v1
kind: ConfigMap
metadata:
  name: clickhouse-init
  namespace: batchsender
data:
  init-schema.sql: |
    -- Single-node ClickHouse schema (no cluster/replication syntax)
    -- Can migrate to ReplicatedMergeTree later when scaling to cluster

    CREATE DATABASE IF NOT EXISTS batchsender;

    -- Email events table
    CREATE TABLE IF NOT EXISTS batchsender.email_events
    (
        event_id UUID DEFAULT generateUUIDv4(),
        event_type String,
        batch_id UUID,
        recipient_id UUID,
        user_id UUID,
        email String,
        provider_message_id String DEFAULT '',
        metadata String DEFAULT '{}',
        error_message String DEFAULT '',
        created_at DateTime64(3) DEFAULT now64(3),
        event_date Date DEFAULT toDate(created_at)
    )
    ENGINE = MergeTree()
    PARTITION BY toYYYYMM(event_date)
    ORDER BY (batch_id, recipient_id, event_type);

    -- Message index for webhook lookups
    CREATE TABLE IF NOT EXISTS batchsender.email_message_index
    (
        provider_message_id String,
        recipient_id UUID,
        batch_id UUID,
        user_id UUID,
        created_at DateTime DEFAULT now()
    )
    ENGINE = MergeTree()
    ORDER BY provider_message_id
    TTL created_at + INTERVAL 30 DAY;

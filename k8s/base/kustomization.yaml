apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: batchsender

resources:
  - namespace.yaml
  - cert-issuer.yaml
  - selfsigned-issuer.yaml
  - rbac.yaml
  # PostgreSQL - For batch metadata storage
  - postgres/statefulset.yaml
  - postgres/service.yaml
  - postgres/init-configmap.yaml
  # DragonflyDB - For distributed rate limiting and hot state
  # NOTE: Requires dragonfly-operator to be installed first (k8s/operators/dragonfly)
  # Legacy single instance (kept for backwards compatibility during migration)
  - dragonfly/dragonfly-instance.yaml
  - dragonfly/service.yaml
  - dragonfly/networkpolicy.yaml
  # New split architecture: critical (batch state) + auxiliary (rate limiting, caching)
  - dragonfly-critical/dragonfly-instance.yaml
  - dragonfly-critical/service.yaml
  - dragonfly-critical/networkpolicy.yaml
  - dragonfly-auxiliary/dragonfly-instance.yaml
  - dragonfly-auxiliary/service.yaml
  - dragonfly-auxiliary/networkpolicy.yaml
  # NATS - Message queue with TLS
  - nats/statefulset.yaml
  - nats/service.yaml
  - nats/service-gateway.yaml
  - nats/configmap.yaml
  - nats/certificate.yaml
  - nats/hpa.yaml
  - nats/networkpolicy.yaml
  - nats/pdb.yaml
  # ClickHouse cluster (3 replicas)
  - clickhouse/statefulset.yaml
  - clickhouse/service.yaml
  - clickhouse/service-external.yaml
  - clickhouse/headless-service.yaml
  - clickhouse/init-configmap.yaml
  - clickhouse/init-job.yaml
  - clickhouse/sealed-secrets.yaml
  - clickhouse/sealed-b2-secret.yaml
  - clickhouse/storage-configmap.yaml
  - clickhouse/cluster-configmap.yaml
  - clickhouse/keeper-configmap.yaml
  - clickhouse/backup-cronjob.yaml
  - clickhouse/ingress.yaml
  - clickhouse/networkpolicy.yaml
  # Worker - Email processing workers
  - worker/configmap.yaml
  - worker/sealed-secrets.yaml
  - worker/deployment.yaml
  - worker/migration-job.yaml
  - worker/service.yaml
  - worker/ingress.yaml
  - worker/networkpolicy.yaml
  # KEDA ScaledObject for instant autoscaling (replaces HPA)
  - worker/keda-scaledobject.yaml
  # worker/hpa.yaml - DISABLED: conflicts with KEDA (only use one or the other)
  - worker/pdb.yaml
  # Web App - Next.js frontend
  - web/configmap.yaml
  - web/sealed-secrets.yaml
  - web/deployment.yaml
  - web/service.yaml
  - web/ingress.yaml
  - web/pdb.yaml

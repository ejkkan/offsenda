# BatchSender Worker Configuration
# Copy this to .env and configure for your environment

# =============================================================================
# DATABASE
# =============================================================================
DATABASE_URL="postgresql://user:password@localhost:5432/batchsender"

# =============================================================================
# NATS JETSTREAM (Message Queue)
# =============================================================================
NATS_CLUSTER="nats://localhost:4222"
NATS_REPLICAS=1
NATS_MAX_MSGS_PER_SUBJECT=1000000  # Max messages per user queue (enterprise: 1M)

# TLS Configuration (production)
NATS_TLS_ENABLED=false
# NATS_TLS_CA_FILE="/path/to/ca.crt"
# NATS_TLS_CERT_FILE="/path/to/client.crt"
# NATS_TLS_KEY_FILE="/path/to/client.key"

# =============================================================================
# CLICKHOUSE (Analytics & Event Storage)
# =============================================================================
CLICKHOUSE_URL="http://localhost:8123"
CLICKHOUSE_USER="default"
CLICKHOUSE_PASSWORD=""
CLICKHOUSE_DATABASE="batchsender"

# Buffered logging settings
CLICKHOUSE_BUFFER_SIZE=10000       # Max events before forced flush
CLICKHOUSE_FLUSH_INTERVAL_MS=5000  # Flush every 5 seconds

# =============================================================================
# DRAGONFLY (Rate Limiting & Hot State Cache)
# =============================================================================
DRAGONFLY_URL="localhost:6379"

# Hot state TTLs
HOT_STATE_COMPLETED_TTL_HOURS=48  # TTL for completed batches
HOT_STATE_ACTIVE_TTL_DAYS=7       # TTL for active batches

# =============================================================================
# EMAIL PROVIDER
# =============================================================================
# Options: "resend", "ses", "mock"
EMAIL_PROVIDER="mock"

# Resend Configuration
RESEND_API_KEY=""

# AWS SES Configuration
AWS_REGION="us-east-1"
AWS_ACCESS_KEY_ID=""
AWS_SECRET_ACCESS_KEY=""
# SES_ENDPOINT=""  # Override for mock server

# Mock Provider Settings (for testing)
MOCK_MODE="success"      # Options: success, fail, random
MOCK_FAILURE_RATE=0.1
MOCK_LATENCY_MS=50

# =============================================================================
# SMS PROVIDER
# =============================================================================
# Options: "telnyx", "mock"
SMS_PROVIDER="mock"

# =============================================================================
# WEBHOOKS (Incoming - Provider Notifications)
# =============================================================================
# Generate with: openssl rand -hex 32
WEBHOOK_SECRET="your-webhook-secret-here"
TELNYX_WEBHOOK_SECRET=""

# Webhook Queue Processing
WEBHOOK_QUEUE_ENABLED=true
WEBHOOK_BATCH_SIZE=100         # Events per batch
WEBHOOK_FLUSH_INTERVAL=1000    # ms between flushes
WEBHOOK_MAX_WORKERS=10
WEBHOOK_DEDUP_TTL=86400        # 24 hours in seconds

# =============================================================================
# WEBHOOKS (Outgoing - User Callbacks)
# =============================================================================
WEBHOOK_TIMEOUT_MS=30000              # 30 second timeout
WEBHOOK_MAX_RETRIES=3
WEBHOOK_RETRY_BASE_DELAY_MS=1000      # 1 second base delay
WEBHOOK_RETRY_MAX_DELAY_MS=10000      # 10 second max delay

# Circuit Breaker
WEBHOOK_CIRCUIT_BREAKER_ENABLED=true
WEBHOOK_CIRCUIT_FAILURE_THRESHOLD=5   # Failures before circuit opens
WEBHOOK_CIRCUIT_RESET_TIMEOUT_MS=30000

# =============================================================================
# SERVER
# =============================================================================
PORT=6001
NODE_ENV="development"  # Options: development, production, test, staging

# =============================================================================
# PROCESSING
# =============================================================================
BATCH_SIZE=100
POLL_INTERVAL_MS=2000
CONCURRENT_BATCHES=50           # Parallel batch processing
MAX_CONCURRENT_EMAILS=200       # Total concurrent email jobs

# Worker identity (unique per instance in K8s)
WORKER_ID="worker-1"

# =============================================================================
# RATE LIMITING
# =============================================================================
# API rate limiting (per IP)
RATE_LIMIT_PER_IP=100           # Requests per minute per IP
DISABLE_RATE_LIMIT=false        # Set true for stress tests only

# Managed mode rate limits (protects shared provider accounts)
# These only apply when users use BatchSender's provider credentials
SYSTEM_RATE_LIMIT=100000        # Global ceiling for managed mode
MANAGED_SES_RATE_LIMIT=14       # AWS SES shared limit
MANAGED_RESEND_RATE_LIMIT=100   # Resend shared limit
MANAGED_TELNYX_RATE_LIMIT=50    # Telnyx SMS shared limit
MANAGED_MOCK_RATE_LIMIT=50000   # Mock provider (stress testing)

# BYOK mode: Users set their own limits via sendConfig.rateLimit
# No limit configured = unlimited (user is responsible for their own provider limits)

# =============================================================================
# REQUEST VALIDATION
# =============================================================================
MAX_REQUEST_SIZE_BYTES=10485760  # 10MB

# =============================================================================
# BATCH RECOVERY SERVICE
# =============================================================================
# Detects and recovers stuck batches
BATCH_RECOVERY_ENABLED=true
BATCH_RECOVERY_INTERVAL_MS=300000    # Check every 5 minutes
BATCH_RECOVERY_THRESHOLD_MS=900000   # Consider stuck after 15 minutes
BATCH_RECOVERY_MAX_PER_SCAN=100

# =============================================================================
# POSTGRESQL BACKGROUND SYNC
# =============================================================================
# Syncs hot state (Dragonfly) to PostgreSQL
POSTGRES_SYNC_ENABLED=true
POSTGRES_SYNC_INTERVAL_MS=2000       # Sync every 2 seconds
POSTGRES_SYNC_BATCH_SIZE=1000        # Max recipients per sync

# =============================================================================
# AUDIT LOGGING
# =============================================================================
AUDIT_ENABLED=true
AUDIT_LOG_TO_CONSOLE=false
AUDIT_BATCH_SIZE=100
AUDIT_FLUSH_INTERVAL_MS=5000

# =============================================================================
# TEST & DEBUG
# =============================================================================
# Admin endpoints for automated testing
TEST_ADMIN_SECRET="your-test-admin-secret-here"
ENABLE_TEST_SETUP_API=""             # Set to "true" to enable in production

# =============================================================================
# TEST API KEY SAFETY (CRITICAL)
# =============================================================================
# API keys starting with "bsk_test_" ALWAYS force dryRun mode.
# This is a safety mechanism like Stripe's test vs live keys.
#
# GUARANTEES:
#   - bsk_test_* keys â†’ batch.dryRun = true (forced at creation time)
#   - dryRun batches NEVER make real outbound API calls
#   - No emails sent, no SMS sent, no webhooks to external URLs
#   - Works in production - safe for e2e testing against live infrastructure
#
# USAGE:
#   - E2E tests: Use bsk_test_* keys (already done in test helpers)
#   - Staging: Can use bsk_test_* keys for safe integration testing
#   - Production: Live keys (bsk_live_*) required for real sends
#
# This cannot be bypassed - the check is in api.ts batch creation endpoint.
# Even if dryRun: false is explicitly passed, test keys force dryRun: true.

# =============================================================================
# QUICK START
# =============================================================================
#
# 1. Copy this file: cp .env.example .env
#
# 2. Configure database:
#    DATABASE_URL="postgresql://user:pass@host:5432/batchsender"
#
# 3. Choose email provider:
#    - Mock (testing): EMAIL_PROVIDER="mock"
#    - Resend: EMAIL_PROVIDER="resend" + RESEND_API_KEY="re_..."
#    - AWS SES: EMAIL_PROVIDER="ses" + AWS credentials
#
# 4. Set webhook secret:
#    WEBHOOK_SECRET="$(openssl rand -hex 32)"
#
# 5. Start services: docker-compose -f docker-compose.local.yml up -d
#
# 6. Start worker: pnpm dev
#
# =============================================================================
# ENVIRONMENT DIFFERENCES
# =============================================================================
#
# Local Development:
#   - EMAIL_PROVIDER="mock"
#   - NATS_TLS_ENABLED=false
#   - All services via docker-compose
#
# Staging:
#   - EMAIL_PROVIDER="resend"
#   - NATS_TLS_ENABLED=true
#   - Reduced resources (see k8s/overlays/staging/)
#
# Production:
#   - EMAIL_PROVIDER="resend"
#   - NATS_TLS_ENABLED=true
#   - External DATABASE_URL (Neon)
#   - Secrets via Sealed Secrets
#

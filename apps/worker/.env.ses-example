# AWS SES Configuration Example
# Copy this to .env and configure for your AWS SES setup

# Database
DATABASE_URL="postgresql://user:password@host:5432/batchsender"

# NATS JetStream
NATS_CLUSTER="nats://localhost:4222"

# ClickHouse
CLICKHOUSE_URL="http://localhost:8123"
CLICKHOUSE_USER="default"
CLICKHOUSE_PASSWORD=""
CLICKHOUSE_DATABASE="batchsender"

# Dragonfly (Redis-compatible - for distributed rate limiting)
DRAGONFLY_URL="localhost:6379"

# Email Provider - AWS SES
EMAIL_PROVIDER="ses"
AWS_REGION="eu-north-1"  # Your AWS region (Europe Stockholm)
AWS_ACCESS_KEY_ID="your-access-key"
AWS_SECRET_ACCESS_KEY="your-secret-key"

# IMPORTANT: Provider Rate Limits
# AWS SES sending limits (from your approval email):
# - Daily quota: 50,000 messages
# - Send rate: 14 messages per second
SES_RATE_LIMIT=14  # Respect AWS SES rate limit

# Note: If you request higher limits from AWS, update this value
# Example: After AWS approves 50 messages/second, set SES_RATE_LIMIT=50

# Webhooks (for delivery/bounce notifications)
WEBHOOK_SECRET="your-webhook-secret-key"

# Server
PORT=6001

# Processing settings
BATCH_SIZE=100
CONCURRENT_BATCHES=10
MAX_CONCURRENT_EMAILS=50  # Can be higher than SES limit - rate limiter handles it

# Worker scaling
WORKER_ID="worker-1"  # Unique ID for each worker instance

# Environment
NODE_ENV="production"

# ============================================================================
# HOW IT WORKS:
# ============================================================================
#
# The system now has TWO levels of rate limiting:
#
# 1. API Rate Limiting (per IP):
#    - Protects your API from abuse
#    - Default: 100 requests per minute per IP
#
# 2. Provider Rate Limiting (distributed):
#    - Respects email provider limits (AWS SES, Resend, etc.)
#    - Uses token bucket algorithm
#    - Coordinated across ALL worker instances via Redis/Dragonfly
#    - Automatically throttles email sending to stay within limits
#
# Example:
# - You have 3 worker instances running
# - Each tries to send 20 emails/second
# - Total would be 60 emails/second
# - BUT: Provider rate limiter coordinates across all workers
# - Result: Only 14 emails/second sent (respecting AWS SES limit)
# - Extra emails wait in queue until tokens are available
#
# ============================================================================
# SCALING BEYOND 14/SEC:
# ============================================================================
#
# Option 1: Request higher AWS limits
#   - Contact AWS support
#   - They typically approve increases quickly
#   - Update SES_RATE_LIMIT when approved
#
# Option 2: Use multiple email providers
#   - Add Resend as backup/overflow
#   - Configure RESEND_RATE_LIMIT=100
#   - System can switch providers automatically
#
# Option 3: Multiple AWS accounts/regions
#   - Each AWS account has separate limits
#   - Run workers with different AWS credentials
#   - Each worker respects its own 14/sec limit
#
# ============================================================================
